{"version":3,"names":["zlogerror","zloginfo","ZegoPluginResult","ZegoUIKitCorePlugin","ZegoPluginUserInRoomAttributesCore","constructor","_defineProperty","shared","getInstance","_registerEngineCallback","getZIMPlugin","default","on","zim","_ref","roomID","infos","operatedInfo","_notifyUsersInRoomAttributesUpdated","map","info","attributesInfo","editor","userID","_unregisterEngineCallback","off","_resetData","_resetDataForLeaveRoom","_roomBaseInfo","_isJoinRoom","notifyData","Object","keys","_onUsersInRoomAttributesUpdatedCallbackMap","forEach","callbackID","joinRoom","Promise","reject","resolve","enterRoom","roomName","then","_ref2","roomInfo","baseInfo","catch","error","code","message","leaveRoom","getRoomBaseInfo","setUsersInRoomAttributes","attributes","userIDs","setRoomMembersAttributes","isDeleteAfterOwnerLeft","_ref3","errorUserList","queryUsersInRoomAttributes","config","queryRoomMemberAttributesList","_ref4","nextFlag","resNextFlag","params","onUsersInRoomAttributesUpdated","callback","_class"],"sources":["user_in_room_attributes_core.ts"],"sourcesContent":["import type {\n  ZIMRoomInfo,\n  ZIMRoomMemberAttributesInfo,\n  ZIMRoomMemberAttributesQueryConfig,\n  ZIMEventOfRoomMembersAttributesUpdatedResult,\n  ZIMRoomEnteredResult,\n  ZIMError,\n  ZIMRoomMembersAttributesOperatedResult,\n  ZIMRoomMemberAttributesListQueriedResult,\n} from 'zego-zim-react-native';\nimport { zlogerror, zloginfo } from '../utils/logger';\nimport ZegoPluginResult from './defines';\nimport ZegoUIKitCorePlugin from \"../../components/internal/ZegoUIKitCorePlugin\";\n\nexport default class ZegoPluginUserInRoomAttributesCore {\n  static shared: ZegoPluginUserInRoomAttributesCore;\n  _isJoinRoom = false;\n  _roomBaseInfo = {} as ZIMRoomInfo; // { roomID: '', roomName: '' }\n  _onUsersInRoomAttributesUpdatedCallbackMap: { [index: string]: (notifyData: {\n    infos: ZIMRoomMemberAttributesInfo[];\n    editor: string;\n  }) => void } = {};\n  constructor() {\n    if (!ZegoPluginUserInRoomAttributesCore.shared) {\n      ZegoPluginUserInRoomAttributesCore.shared = this;\n    }\n    return ZegoPluginUserInRoomAttributesCore.shared;\n  }\n  static getInstance() {\n    if (!ZegoPluginUserInRoomAttributesCore.shared) {\n      ZegoPluginUserInRoomAttributesCore.shared =\n        new ZegoPluginUserInRoomAttributesCore();\n    }\n    return ZegoPluginUserInRoomAttributesCore.shared;\n  }\n  // ------- internal events register ------\n  _registerEngineCallback() {\n    ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance().on(\n      'roomMemberAttributesUpdated',\n      (zim: any, { roomID, infos, operatedInfo }: ZIMEventOfRoomMembersAttributesUpdatedResult) => {\n        zloginfo(\n          `[ZegoPluginUserInRoomAttributesCore]NotifyUsersInRoomAttributesUpdated`,\n          infos,\n          operatedInfo\n        );\n        this._notifyUsersInRoomAttributesUpdated({\n          infos: infos.map((info) => info.attributesInfo),\n          editor: operatedInfo.userID,\n        });\n      }\n    );\n    zloginfo(\n      '[ZegoPluginUserInRoomAttributesCore]Register callback for ZIM...'\n    );\n  }\n  _unregisterEngineCallback() {\n    zloginfo(\n      '[ZegoPluginUserInRoomAttributesCore]Unregister callback from ZIM...'\n    );\n    ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance().off('roomMemberAttributesUpdated');\n  }\n  // ------- internal utils ------\n  _resetData() {\n    this._resetDataForLeaveRoom();\n  }\n  _resetDataForLeaveRoom() {\n    this._roomBaseInfo = {} as ZIMRoomInfo;\n    this._isJoinRoom = false;\n  }\n  // ------- internal events exec ------\n  _notifyUsersInRoomAttributesUpdated(notifyData: {\n    infos: ZIMRoomMemberAttributesInfo[];\n    editor: string;\n  }) {\n    Object.keys(this._onUsersInRoomAttributesUpdatedCallbackMap).forEach(\n      (callbackID) => {\n        if (this._onUsersInRoomAttributesUpdatedCallbackMap[callbackID]) {\n          this._onUsersInRoomAttributesUpdatedCallbackMap[callbackID](\n            notifyData\n          );\n        }\n      }\n    );\n  }\n  // ------- external method ------\n  joinRoom(roomID: string) {\n    if (!ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()) {\n      zlogerror(\n        '[ZegoPluginUserInRoomAttributesCore]Please initialize it first.'\n      );\n      return Promise.reject();\n    }\n    return new Promise((resolve, reject) => {\n      if (!this._isJoinRoom) {\n        ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()\n          .enterRoom({ roomID, roomName: roomID })\n          .then(({ roomInfo }: ZIMRoomEnteredResult) => {\n            zloginfo(\n              `[ZegoPluginUserInRoomAttributesCore]Join the room successfully.`\n            );\n            this._roomBaseInfo = roomInfo.baseInfo;\n            this._isJoinRoom = true;\n            resolve(new ZegoPluginResult('', ''));\n          })\n          .catch((error: ZIMError) => {\n            zlogerror(\n              `[ZegoPluginUserInRoomAttributesCore]Failed to join the room, code: ${error.code}, message: ${error.message}`\n            );\n            reject(error);\n          });\n      } else {\n        zloginfo('[ZegoPluginUserInRoomAttributesCore]Join room already success.');\n        resolve(new ZegoPluginResult('', ''));\n      }\n    });\n  }\n  leaveRoom() {\n    if (!ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()) {\n      zlogerror(\n        '[ZegoPluginUserInRoomAttributesCore]Please initialize it first.'\n      );\n      return Promise.reject();\n    }\n    if (!this._roomBaseInfo.roomID) {\n      zlogerror(\n        '[ZegoPluginUserInRoomAttributesCore]Please join the room first.'\n      );\n      return Promise.reject();\n    }\n    return new Promise((resolve, reject) => {\n      ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()\n        .leaveRoom(this._roomBaseInfo.roomID)\n        .then(() => {\n          zloginfo(\n            `[ZegoPluginUserInRoomAttributesCore]Leave the room successfully.`\n          );\n          this._resetDataForLeaveRoom();\n          resolve(new ZegoPluginResult('', ''));\n        })\n        .catch((error: ZIMError) => {\n          zlogerror(\n            `[ZegoPluginUserInRoomAttributesCore]Failed to leave the room, code: ${error.code}, message: ${error.message}`\n          );\n          reject(error);\n        });\n    });\n  }\n  getRoomBaseInfo() {\n    return this._roomBaseInfo;\n  }\n  setUsersInRoomAttributes(attributes: Record<string, string>, userIDs: string[]) {\n    if (!ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()) {\n      zlogerror(\n        '[ZegoPluginUserInRoomAttributesCore]Please initialize it first.'\n      );\n      return Promise.reject();\n    }\n    return new Promise((resolve, reject) => {\n      ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()\n        .setRoomMembersAttributes(\n          attributes,\n          userIDs,\n          this._roomBaseInfo.roomID,\n          { isDeleteAfterOwnerLeft: true }\n        )\n        .then(({ roomID, infos, errorUserList }: ZIMRoomMembersAttributesOperatedResult) => {\n          zloginfo(\n            `[ZegoPluginUserInRoomAttributesCore]Set attributes of users in room successfully.`\n          );\n          resolve({\n            ...new ZegoPluginResult('', ''),\n            errorUserList,\n            infos,\n          });\n        })\n        .catch((error: ZIMError) => {\n          zlogerror(\n            `[ZegoPluginUserInRoomAttributesCore]Failed to set the user's attributes, code: ${error.code}, message: ${error.message}`\n          );\n          reject(error);\n        });\n    });\n  }\n  queryUsersInRoomAttributes(config: ZIMRoomMemberAttributesQueryConfig) {\n    if (!ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()) {\n      zlogerror(\n        '[ZegoPluginUserInRoomAttributesCore]Please initialize it first.'\n      );\n      return Promise.reject();\n    }\n    return new Promise((resolve, reject) => {\n      ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()\n        .queryRoomMemberAttributesList(this._roomBaseInfo.roomID, config)\n        .then(({ roomID, infos, nextFlag: resNextFlag }: ZIMRoomMemberAttributesListQueriedResult) => {\n          zloginfo(\n            `[ZegoPluginUserInRoomAttributesCore]Query attributes of users in room successfully.`\n          );\n          const params = {\n            ...new ZegoPluginResult('', ''),\n            nextFlag: resNextFlag,\n            infos,\n          };\n          resolve(params);\n        })\n        .catch((error: ZIMError) => {\n          zlogerror(\n            `[ZegoPluginUserInRoomAttributesCore]Failed to query the user's attributes, code: ${error.code}, message: ${error.message}`\n          );\n          reject(error);\n        });\n    });\n  }\n  // ------- external events register ------\n  onUsersInRoomAttributesUpdated(callbackID: string, callback: (notifyData: {\n    infos: ZIMRoomMemberAttributesInfo[];\n    editor: string;\n  }) => void) {\n    if (!ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()) {\n      zlogerror(\n        '[ZegoPluginUserInRoomAttributesCore]Please initialize it first.'\n      );\n    }\n    if (typeof callback !== 'function') {\n      if (callbackID in this._onUsersInRoomAttributesUpdatedCallbackMap) {\n        zloginfo(\n          '[Core][onUsersInRoomAttributesUpdated] Remove callback for: [',\n          callbackID,\n          '] because callback is not a valid function!'\n        );\n        delete this._onUsersInRoomAttributesUpdatedCallbackMap[callbackID];\n      }\n    } else {\n      this._onUsersInRoomAttributesUpdatedCallbackMap[callbackID] = callback;\n    }\n  }\n}\n"],"mappings":"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"}